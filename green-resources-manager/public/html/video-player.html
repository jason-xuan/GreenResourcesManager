<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            outline: none;
        }
        
        .error-message {
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .loading-message {
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <div id="loadingMessage" class="loading-message">æ­£åœ¨åŠ è½½è§†é¢‘...</div>
        <video id="videoPlayer" controls style="display: none;">
            <source id="videoSource" src="" type="">
            <source id="videoSourceFallback" src="" type="">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
        </video>
    </div>
    
    <script>
        const video = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        const videoSourceFallback = document.getElementById('videoSourceFallback');
        const loadingMessage = document.getElementById('loadingMessage');
        
        // ä» URL å‚æ•°è·å–è§†é¢‘æ–‡ä»¶è·¯å¾„å’Œæ ‡é¢˜
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                path: params.get('path') || '',
                title: params.get('title') || 'è§†é¢‘æ’­æ”¾å™¨'
            };
        }
        
        const { path: videoPath, title } = getUrlParams();
        
        // è®¾ç½®çª—å£æ ‡é¢˜
        if (title) {
            document.title = title;
        }
        
        console.log('è§†é¢‘æ–‡ä»¶è·¯å¾„:', videoPath);
        
        // æ£€æŸ¥è§†é¢‘æ ¼å¼æ”¯æŒ
        function checkVideoFormatSupport(filePath) {
            const extension = filePath.toLowerCase().split('.').pop();
            const supportedFormats = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'mkv', 'flv', 'wmv'];
            return supportedFormats.includes(extension);
        }
        
        // è·å–è§†é¢‘MIMEç±»å‹
        function getVideoMimeType(filePath) {
            const extension = filePath.toLowerCase().split('.').pop();
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'ogg': 'video/ogg',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'mkv': 'video/x-matroska',
                'flv': 'video/x-flv',
                'wmv': 'video/x-ms-wmv',
                'm4v': 'video/mp4',
                '3gp': 'video/3gpp',
                'ogv': 'video/ogg'
            };
            return mimeTypes[extension] || 'video/mp4'; // é»˜è®¤ä½¿ç”¨mp4
        }
        
        // æ„å»ºæ­£ç¡®çš„ file:// URL
        function buildFileUrl(filePath) {
            try {
                // å°†åæ–œæ è½¬æ¢ä¸ºæ­£æ–œæ ï¼Œå¹¶ç¡®ä¿è·¯å¾„ä»¥ / å¼€å¤´
                const normalized = filePath.replace(/\\\\/g, '/').replace(/^([A-Za-z]:)/, '/$1');
                
                // å¯¹è·¯å¾„è¿›è¡Œç¼–ç ï¼Œå¤„ç†ä¸­æ–‡å’Œç‰¹æ®Šå­—ç¬¦
                const encoded = normalized.split('/').map(seg => {
                    if (seg.includes(':')) {
                        // å¤„ç† Windows ç›˜ç¬¦ï¼ˆå¦‚ C:ï¼‰
                        return seg;
                    }
                    return encodeURIComponent(seg);
                }).join('/');
                
                const fileUrl = 'file://' + encoded;
                console.log('æ„å»ºçš„ file:// URL:', fileUrl);
                return fileUrl;
            } catch (error) {
                console.error('æ„å»ºæ–‡ä»¶URLå¤±è´¥:', error);
                return filePath; // é™çº§è¿”å›åŸå§‹è·¯å¾„
            }
        }
        
        // è®¾ç½®è§†é¢‘æº
        function setupVideoSource() {
            try {
                console.log('å¼€å§‹è®¾ç½®è§†é¢‘æº...');
                
                if (!videoPath) {
                    showError('æœªæä¾›è§†é¢‘æ–‡ä»¶è·¯å¾„');
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
                if (!checkVideoFormatSupport(videoPath)) {
                    const extension = videoPath.toLowerCase().split('.').pop();
                    showError('ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼: ' + extension + '\n\nå»ºè®®ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨æ’­æ”¾æ­¤æ–‡ä»¶');
                    return;
                }
                
                // æ„å»ºæ­£ç¡®çš„ file:// URL
                const videoUrl = buildFileUrl(videoPath);
                const mimeType = getVideoMimeType(videoPath);
                console.log('è®¾ç½®è§†é¢‘URL:', videoUrl);
                console.log('è§†é¢‘MIMEç±»å‹:', mimeType);
                
                // ä½¿ç”¨ source å…ƒç´ è®¾ç½®è§†é¢‘æº
                videoSource.src = videoUrl;
                videoSource.type = mimeType;
                
                // è®¾ç½®å¤‡ç”¨sourceï¼ˆä½¿ç”¨é€šç”¨MIMEç±»å‹ï¼‰
                videoSourceFallback.src = videoUrl;
                videoSourceFallback.type = 'video/*';
                
                // æ˜¾ç¤ºè§†é¢‘å…ƒç´ 
                video.style.display = 'block';
                loadingMessage.style.display = 'none';
                
                // é‡æ–°åŠ è½½è§†é¢‘
                video.load();
                
                console.log('âœ… è§†é¢‘æºè®¾ç½®å®Œæˆ');
            } catch (error) {
                console.error('è®¾ç½®è§†é¢‘æºå¤±è´¥:', error);
                showError('è®¾ç½®è§†é¢‘æºå¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorHtml = '<div class="error-message">' +
                '<h3>âŒ è§†é¢‘æ’­æ”¾å¤±è´¥</h3>' +
                '<p>' + message.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>' +
                '<div style="margin-top: 20px;">' +
                    '<button onclick="openWithExternalPlayer()" style="' +
                        'background: #007acc;' +
                        'color: white;' +
                        'border: none;' +
                        'padding: 10px 20px;' +
                        'border-radius: 5px;' +
                        'cursor: pointer;' +
                        'margin-right: 10px;' +
                    '">ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨æ‰“å¼€</button>' +
                    '<button onclick="window.close()" style="' +
                        'background: #666;' +
                        'color: white;' +
                        'border: none;' +
                        'padding: 10px 20px;' +
                        'border-radius: 5px;' +
                        'cursor: pointer;' +
                    '">å…³é—­çª—å£</button>' +
                '</div>' +
            '</div>';
            document.body.innerHTML = errorHtml;
        }
        
        // ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨æ‰“å¼€è§†é¢‘
        function openWithExternalPlayer() {
            try {
                // é€šè¿‡ Electron API æ‰“å¼€å¤–éƒ¨æ’­æ”¾å™¨
                if (window.electronAPI && window.electronAPI.openExternal) {
                    window.electronAPI.openExternal(videoPath);
                    window.close();
                } else {
                    alert('æ— æ³•æ‰“å¼€å¤–éƒ¨æ’­æ”¾å™¨ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€æ–‡ä»¶: ' + videoPath);
                }
            } catch (error) {
                console.error('æ‰“å¼€å¤–éƒ¨æ’­æ”¾å™¨å¤±è´¥:', error);
                alert('æ‰“å¼€å¤–éƒ¨æ’­æ”¾å™¨å¤±è´¥: ' + error.message);
            }
        }
        
        
        // è§†é¢‘åŠ è½½å®Œæˆ
        video.addEventListener('loadedmetadata', () => {
            console.log('è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ');
            console.log('è§†é¢‘æ—¶é•¿:', video.duration, 'ç§’');
        });
        
        // è§†é¢‘å¯ä»¥æ’­æ”¾
        video.addEventListener('canplay', () => {
            console.log('è§†é¢‘å¯ä»¥å¼€å§‹æ’­æ”¾');
        });
        
        // è§†é¢‘å¼€å§‹æ’­æ”¾
        video.addEventListener('play', () => {
            console.log('è§†é¢‘å¼€å§‹æ’­æ”¾');
        });
        
        // è§†é¢‘é”™è¯¯å¤„ç†
        video.addEventListener('error', (e) => {
            console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', e);
            console.error('é”™è¯¯è¯¦æƒ…:', video.error);
            let errorMessage = 'è§†é¢‘åŠ è½½å¤±è´¥';
            let suggestion = '';
            
            if (video.error) {
                switch(video.error.code) {
                    case 1:
                        errorMessage = 'è§†é¢‘åŠ è½½è¢«ä¸­æ­¢';
                        suggestion = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ–‡ä»¶æ˜¯å¦è¢«å ç”¨';
                        break;
                    case 2:
                        errorMessage = 'ç½‘ç»œé”™è¯¯å¯¼è‡´è§†é¢‘ä¸‹è½½å¤±è´¥';
                        suggestion = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®';
                        break;
                    case 3:
                        errorMessage = 'è§†é¢‘è§£ç é”™è¯¯';
                        suggestion = 'è§†é¢‘æ–‡ä»¶å¯èƒ½æŸåï¼Œå»ºè®®ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨';
                        break;
                    case 4:
                        errorMessage = 'è§†é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå';
                        suggestion = 'æ­¤è§†é¢‘æ ¼å¼ä¸è¢«æµè§ˆå™¨æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨';
                        break;
                    default:
                        errorMessage = 'æœªçŸ¥çš„è§†é¢‘æ’­æ”¾é”™è¯¯';
                        suggestion = 'è¯·å°è¯•ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨';
                }
            }
            
            const fullMessage = errorMessage + '\n\n' + suggestion + '\n\nè¯·æ£€æŸ¥ï¼š\n1. æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n2. æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ\n3. æ–‡ä»¶æ˜¯å¦æŸå';
            showError(fullMessage);
        });
        
        // source å…ƒç´ é”™è¯¯å¤„ç†
        videoSource.addEventListener('error', (e) => {
            console.error('ä¸»è§†é¢‘æºåŠ è½½é”™è¯¯:', e);
            console.log('å°è¯•çš„æºURL:', videoSource.src);
            console.log('å°è¯•çš„MIMEç±»å‹:', videoSource.type);
            console.log('ğŸ”„ ä¸»sourceå¤±è´¥ï¼Œæµè§ˆå™¨å°†å°è¯•å¤‡ç”¨source');
        });
        
        // å¤‡ç”¨sourceå…ƒç´ é”™è¯¯å¤„ç†
        videoSourceFallback.addEventListener('error', (e) => {
            console.error('å¤‡ç”¨è§†é¢‘æºåŠ è½½é”™è¯¯:', e);
            console.log('å°è¯•çš„å¤‡ç”¨æºURL:', videoSourceFallback.src);
            console.log('å°è¯•çš„å¤‡ç”¨MIMEç±»å‹:', videoSourceFallback.type);
            
            // å¦‚æœæ‰€æœ‰sourceéƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥è®¾ç½®video.srcä½œä¸ºæœ€åçš„é™çº§æ–¹æ¡ˆ
            console.log('ğŸ”„ æ‰€æœ‰sourceå…ƒç´ éƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥è®¾ç½®video.srcä½œä¸ºæœ€åé™çº§æ–¹æ¡ˆ');
            try {
                video.src = videoSource.src;
                video.load();
            } catch (fallbackError) {
                console.error('æœ€åé™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                showError('æ‰€æœ‰è§†é¢‘æºåŠ è½½å¤±è´¥ï¼Œæ— æ³•æ’­æ”¾æ­¤æ–‡ä»¶\n\nå»ºè®®ä½¿ç”¨å¤–éƒ¨æ’­æ”¾å™¨');
            }
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                    break;
                case 'Escape':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    break;
                case 'ArrowLeft':
                    video.currentTime = Math.max(0, video.currentTime - 10);
                    break;
                case 'ArrowRight':
                    video.currentTime = Math.min(video.duration, video.currentTime + 10);
                    break;
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®è§†é¢‘æº
        document.addEventListener('DOMContentLoaded', () => {
            console.log('è§†é¢‘æ’­æ”¾å™¨é¡µé¢å·²åŠ è½½');
            setupVideoSource();
        });
    </script>
</body>
</html>

